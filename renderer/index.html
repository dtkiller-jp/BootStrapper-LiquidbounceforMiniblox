<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Miniblox Launcher</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Liquidbounce For Miniblox</h1>
    </div>
    
    <div class="content">
      <div class="left">
        <select id="version" class="version-select">
          <option value="">Loading...</option>
        </select>
        <div id="progress-container" class="progress-container" style="display: none;">
          <div id="progress-bar" class="progress-bar"></div>
          <span id="progress-text" class="progress-text">0%</span>
        </div>
      </div>
      
      <div class="right">
        <button id="launch" class="launch-btn">Launch</button>
      </div>
    </div>
  </div>

  <script>
    const versionSelect = document.getElementById("version");

    // 初期化
    Promise.all([window.api.getConfig(), window.api.getAvailableScripts()])
      .then(([config, versions]) => {
        console.log("Config:", config);
        console.log("Versions:", versions);
        
        versionSelect.innerHTML = "";
        
        if (!versions || versions.length === 0) {
          const opt = document.createElement("option");
          opt.textContent = "No versions available";
          versionSelect.appendChild(opt);
          return;
        }

        versions.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v.url;
          opt.textContent = v.name;
          versionSelect.appendChild(opt);
        });

        // configのURLが一致するものを選択
        const found = [...versionSelect.options].find(o => o.value === config.userscriptUrl);
        if (found) {
          versionSelect.value = found.value;
        } else if (versionSelect.options.length > 0) {
          versionSelect.selectedIndex = 0;
        }
      })
      .catch(e => {
        console.error("Initialization error:", e);
        versionSelect.innerHTML = '<option>Error loading versions</option>';
      });

    // バージョン変更時
    versionSelect.addEventListener("change", () => {
      const selected = versionSelect.value;
      window.api.setConfig({ userscriptUrl: selected });
    });

    // クライアント起動（自動更新付き）
    document.getElementById("launch").onclick = async () => {
      const launchBtn = document.getElementById("launch");
      const progressContainer = document.getElementById("progress-container");
      const progressBar = document.getElementById("progress-bar");
      const progressText = document.getElementById("progress-text");
      
      launchBtn.disabled = true;
      versionSelect.style.display = "none";
      progressContainer.style.display = "block";
      
      // プログレスバーアニメーション
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 5;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + "%";
        progressText.textContent = progress + "%";
      }, 100);
      
      try {
        await window.api.launchClient();
        
        clearInterval(progressInterval);
        progressBar.style.width = "100%";
        progressText.textContent = "100%";
        
        setTimeout(() => {
          // Launcherは自動的に閉じる
        }, 500);
      } catch (e) {
        clearInterval(progressInterval);
        console.error("Launch error:", e);
        launchBtn.disabled = false;
        versionSelect.style.display = "block";
        progressContainer.style.display = "none";
        progressBar.style.width = "0%";
      }
    };
  </script>
</body>
</html>
