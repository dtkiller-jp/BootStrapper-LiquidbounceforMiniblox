<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Miniblox Launcher</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Miniblox</h1>
    <h2>Client Launcher</h2>
    
    <div class="section">
      <label for="version">Userscript Version</label>
      <select id="version">
        <option value="">Loading...</option>
      </select>
      <p id="desc" class="description"></p>
      <p id="updated" class="updated"></p>
    </div>

    <div class="section">
      <button id="launch" class="btn btn-primary">Launch</button>
    </div>

    <p id="status" class="status"></p>
  </div>

  <script>
    const versionSelect = document.getElementById("version");
    const status = document.getElementById("status");
    const desc = document.getElementById("desc");
    const updated = document.getElementById("updated");

    // 初期化
    console.log("Initializing...");
    
    Promise.all([window.api.getConfig(), window.api.getAvailableScripts()])
      .then(([config, versions]) => {
        console.log("Config:", config);
        console.log("Versions:", versions);
        
        versionSelect.innerHTML = "";
        
        if (!versions || versions.length === 0) {
          const opt = document.createElement("option");
          opt.textContent = "No versions available";
          versionSelect.appendChild(opt);
          status.textContent = "Failed to load userscript versions";
          return;
        }

        versions.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v.url;
          opt.textContent = v.name;
          opt.dataset.desc = v.description || "";
          opt.dataset.version = v.version || "";
          versionSelect.appendChild(opt);
        });

        // configのURLが一致するものを選択
        const found = [...versionSelect.options].find(o => o.value === config.userscriptUrl);
        if (found) {
          versionSelect.value = found.value;
          desc.textContent = found.dataset.desc || "";
          updated.textContent = found.dataset.version ? `Version: ${found.dataset.version}` : "";
        } else if (versionSelect.options.length > 0) {
          // 一致しない場合は最初のオプションを選択
          versionSelect.selectedIndex = 0;
          const firstOption = versionSelect.options[0];
          desc.textContent = firstOption.dataset.desc || "";
          updated.textContent = firstOption.dataset.version ? `Version: ${firstOption.dataset.version}` : "";
        }
        
        status.textContent = "Ready";
      })
      .catch(e => {
        console.error("Initialization error:", e);
        status.textContent = "Error loading configuration: " + e.message;
        versionSelect.innerHTML = '<option>Error loading versions</option>';
      });

    // バージョン変更時
    versionSelect.addEventListener("change", () => {
      const selected = versionSelect.value;
      const selectedOption = versionSelect.selectedOptions[0];
      desc.textContent = selectedOption?.dataset.desc || "";
      updated.textContent = selectedOption?.dataset.version ? `Version: ${selectedOption.dataset.version}` : "";
      window.api.setConfig({ userscriptUrl: selected });
    });

    // クライアント起動（自動更新付き）
    document.getElementById("launch").onclick = async () => {
      const launchBtn = document.getElementById("launch");
      launchBtn.disabled = true;
      
      status.textContent = "Checking for updates...";
      
      try {
        const result = await window.api.launchClient();
        status.textContent = result;
      } catch (e) {
        status.textContent = "Error: " + e.message;
        launchBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
